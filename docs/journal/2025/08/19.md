# 開発日記 - 2025年08月19日（火）

## 📋 本日の作業概要
- 要件/計画/アーキ整備を完了。監査Producer（wrap/proxy）と最小ルールを実装し、CIはActionsランナー（ubuntu-latest）でのBuild＋軽量E2Eに統一。
- なぜ今: eBPF非採用（Phase4）前提で“現実的・安全な観測”を早期に成立させ、設計前提を固定。

## 🧭 コンテキスト/背景
- 制約: GitHub Actionsランナーのみで回す（特権/カーネル依存なし）。メタデータ中心でプライバシーを担保。
- 痛点: Pushトリガのノイズ、E2Eの環境依存、ドキュメント導線の散在。
- 参照: falco-nginx-plugin の日報/CI設計/運用知見を転用（INDEXからクリック導線）。

## 🎯 完了したタスク
### 1. アーキ概要の再構成（OVERVIEW.md） ✅
- 背景/問題: 初稿は大雑把で参照性が低い。
- 意思決定/トレードオフ: 詳細はDETAILED.mdに寄せ、OVERVIEWは“読む順番”で俯瞰できる密度に。図はASCIIでCI/差分に強く。
- 対応/変更: MECEで構成（目的/前提/結論/構成/データ/フロー/非機能/導入/受入/リスク/次アクション）。ASCII図を追加。
- 結果/検証: 参照箇所が明確化し、INDEXからの導線で即時到達可能。
 - 影響/リスク: 初学者に負担が少ない一方、詳細リンク切れはINDEXで吸収。

### 2. 監査Producer（wrap/proxy）実装 ✅
- 背景/問題: eBPFなしでリアルタイム観測が必要。
- 対応/変更: `mcp-audit-wrap`（stdio中継/バイト集計）と `mcp-audit-proxy`（tcp/ws透過）を追加。`pkg/audit/event.go` でJSONL出力。
- 意思決定/トレードオフ: wrapは導入容易、proxyはURL差替のみ。`.method` 抽出はPhase2で段階導入（精度と実装コストのバランス）。
- 結果/検証: ローカルで `--sink stdout` にてイベント出力を確認。
 - 影響/リスク: proxyはwssのmethod抽出に制約。将来はclient-emitter併用で補完。

### 3. 最小ルール4本の整備 ✅
- 背景/問題: 検知要件（未承認/非TLS/大量/過剰）を早期に固定。
- 対応/変更: `rules/templates/mcp_baseline_rules.yaml` と `rules/mcp_baseline.yaml` を追加（未承認/非TLS/大量/過剰）。
- 結果/検証: サンプルE2Eでフィールド整合を確認。
 - 影響/リスク: 閾値の環境差は後続でYAML外部化（P2-5）。

### 4. CI（Actionsランナー）初期整備 ✅
- 背景/問題: Pushでのノイズとパス不整合。
- 対応/変更: PR/手動トリガに限定、E2Eパス修正、ビルド/軽量E2Eを実行。
- 結果/検証: 安定完走。`test-results/` を成果物化（最小）。後続でStep Summaryに集計を追加予定。
 - 影響/リスク: 早期段階はゲート緩め（`|| true`）。段階的にゲートを強化（P2-4）。

## 💡 重要な発見/知見/効率改善
- メタデータ中心の監査（内容非収集）で十分に運用可能。`server_host/tls/bytes/method(count)` の組み合わせで主要検知が成立。
- INDEXのクリックリンク＋1行サマリは、オンボーディングとレビュー効率を明確に改善。

## 🐛 失敗と学び（Retrospective）
- CI失敗（パス不整合）: E2E実行の相対パス修正で解消。以後パスは`docs/INDEX.md`と同様の相対表現に統一。
- Pushトリガのノイズ: PR/手動のみへ切替。将来は守るべきゲートが固まってからPushに段階導入。
- `tools.exec` 応答肥大化: ランナー資源保護のためmcp-test-serverのpayloadを5MiBに上限設定。

## 🛠 解決した問題/対応（What & How）
- ワークフローパス不整合による失敗
  - 症状: `Run E2E` でテストスクリプトが見つからず失敗。
  - 原因: `bash falco-mcpserver-plugin/test/...` と1階層深い相対パスを使用。
  - 切り分け: Actionsログから`No such file or directory`を確認、ワークスペースカレントを再確認。
  - 対応: `.github/workflows/ci.yml` を `bash test/...` に修正し、Pushトリガを無効化、PR/手動に限定。
  - 検証: 次回実行で成功（Build/E2Eが完走）。

- 監査の大容量応答による実行時間/メモリリスク
  - 症状: `tools.exec` に大サイズを指定するとランナー資源を圧迫する懸念。
  - 原因: 応答payloadが制限なしで生成可能だった。
  - 対応: `mcp-test-server` のpayload生成を5MiB上限に制限（安全弁）。
  - 検証: 統合テスト `stdio_wrap_basic.sh` の `--resp-size-bytes 2048` で軽量確認、Artifactsに記録。

## 🥵 苦労した点/ハマりどころ（Challenges）
- 「詳細と俯瞰のバランス」: OVERVIEWに何を残し何をDETAILEDへ寄せるかの線引きに時間。方針として“読む順=理解の順”を採用し、詳細はリンクで分離。
- 「CIの最小ゲート設計」: 早期に強いゲートを入れると速度が落ちるため、まずは“壊れない/読める/残る（Artifacts）”を優先。数値ゲートは段階導入に。

## 🧠 所感/振り返り（Reflections）
- Actionsランナー前提という制約が、結果的に「安全なメタ観測＋決定論的テスト」という筋の良い設計判断を後押しした。制約駆動の設計は、初期フェーズでは混乱を減らす。
- 「読む順 = 理解の順」に沿ったOVERVIEWの構成は、後日読み返した際の負債を減らすと実感。図はASCIIで十分価値がある（差分/レビューに強い）。
- E2Eは早く“SKIPでいいから配線確認”を入れるのが有効。成功/失敗の二値ではなく「可観測な前進」を重ねやすい。

## 📊 証跡/メトリクス
- 成果物: `test-results/audit_stdio.jsonl`（Actions Artifacts）
- ビルド: `go build ./cmd/mcp-audit-wrap`, `./cmd/mcp-audit-proxy`, `./cmd/mcp-test-server`
- ログ: Actions Run の “Run Integration” / “Upload test artifacts” を参照

## 📊 現在のプロジェクト状態
- [PH-1] フェーズ1 完了（スキーマ/Producer最小/ルール/CI初期）
- [PH-2] フェーズ2 着手（stdioテストサーバ/統合テストの土台）

## 🔄 明日以降の予定（Acceptance明記）
- [NX-1]/[P2-1.2] WSモード実装（`ws://` listen, echo応答）。受入: `go build`成功、単発呼出で200ms未満応答。
- [NX-2]/[P2-2.2] WS統合テスト（proxy経由）。受入: 監査JSONに`server_host`/`tls=true`/`bytes>0`が出現。
- [NX-3]/[P2-3] `.method` 抽出/per-call出力（flagで有効化）。
- [NX-5]/[P2-4] Step Summary 集計強化（PASS/FAIL/SKIP）。受入: サマリ表に数値が出力。

## 📝 メモ
- INDEXのクリックリンク＋1行サマリで参照性を確保。開発日記は日別ファイルに分割。
