# 目的

MCP Server 向け Falco プラグイン（以降「MCP プラグイン」）の開発を段階的に推進し、短期で価値を提供しつつ、将来拡張に耐える土台（スキーマ/ルール/テスト/CI）を整備する。

# 前提

- ランタイム: 自己ホストRunner/ローカル環境（Falcoはドライバレス可）。
- ポリシー: SDK-first、小さく可逆、CI優先、SKIPポリシー、PII最小化。
- 入力: まずは MCP 監査 JSON（sidecar/proxy/クライアントで生成）。将来 eBPF/プロキシ連携に拡張。

# 結論（要旨）

- フェーズ1で「監査JSON→mcp.*フィールド→ルール→JSONアサーションE2E」を成立させ、基本検知4本を提供。
- フェーズ2で「カバレッジ拡張（メトリクス/しきい値学習/許可リスト運用）と CI 可視化」を強化。
- フェーズ3で「観測面の拡張（eBPF/プロキシ）と運用自動化（集計/レポート）」に進む。

# フェーズ計画

- フェーズ1（MVP, 観測最小・検知最小）
  - 監査スキーマ v1 固定（`docs/schema/mcp_audit_v1.json`）。
  - SDK雛形 + `mcp.*` 抽出（StringPool 準拠）とユニットテスト。
  - ルール最小4本: 未承認エンドポイント/非TLS/大量送信/過剰ツール呼び出し。
  - E2E（JSONアサーション）/SKIPポリシー/アーティファクト収集。
  - ポリシー: eBPF/カーネルモジュールは不使用。監査は StdIO/WS/クライアント内で生成。
- フェーズ2（品質/運用強化）
  - 許可リストの管理外部化（YAML）としきい値整備（環境別上書き）。
  - しきい値検出率の導入、CI Step Summary 可視化（統計・内訳）。
  - サンプルデータ拡充、エッジケース（壊れたJSON/欠損フィールド）耐性強化。
- フェーズ3（観測拡張/自動化）
  - eBPF/システムコール観測 or 軽量プロキシでネットワーク/ファイルI/O補足。
  - 日次レポート/傾向検知（しきい値自動提案）、許可リスト更新ワークフロー。

# マイルストーン / 成果物

- M1: スキーマ・雛形
  - 成果物: `docs/schema/mcp_audit_v1.json`、コード生成雛形、フィールド一覧。
- M2: ルール・テスト
  - 成果物: ルール4本（テンプレ→本線）、サンプルJSON、E2E スクリプト。
- M3: CI 可視化/安定化
  - 成果物: SKIP方針徹底、`test-results/` 収集、Step Summary（検出統計）。
- M4: 運用パラメータ外部化
  - 成果物: 許可リスト/しきい値/YAML化、環境別上書き、ドキュメント更新。
- M5: 観測拡張 PoC
  - 成果物: eBPF/プロキシのいずれかの PoC と評価レポート。

# 受入基準

- ユニット: JSON→フィールド変換のテーブル駆動テストが安定通過。
- E2E: 代表シナリオで `.rule/.priority/output_fields["mcp.*"]` が一致。
- CI: 自己ホストRunnerで安定、`jq bc file` 導入、SKIP時は明確な理由を出力。
- 互換: `mcp.*` フィールドは後方互換、追加はOK/リネームは原則禁止（同時にルール/テスト更新）。

# リスク/代替

- 監査フィード未整備 → 代替: クライアントラッパ/ローカルプロキシで JSON を生成。
- 過検知/誤検知 → 代替: 許可リスト/学習期間/検出率しきい値/緩和ルールを導入。
- プライバシー懸念 → 代替: レッドアクト/ハッシュ化/オプトアウト設定と透明性の文書化。

# タイムライン（例示）

- 週1–2: M1/M2 完了（スキーマ・ルール・E2E 最小）
- 週3–4: M3/M4 完了（CI 可視化・運用外部化）
- 週5+: M5 PoC と次期計画レビュー

# 体制/役割（R&R）

- オーナー: 要件/優先度の決定、受入判断。
- 実装: プラグイン/ルール/テスト/スクリプトの実装と文書更新。
- レビュー: 互換性・セキュリティ・性能の観点レビュー、CI 監視。

# 運用/CI

- ランナー: `runs-on: [self-hosted, linux, x64, local]` を前提。
- 依存: `jq bc file` を明示インストール。アーティファクト収集を標準化。
- ガード: `grep -r "ubuntu-latest" .github/workflows` などで誤設定を検知。

# 次アクション

- M1 実行: コード生成の実装（`scripts/gen-fields.sh` 強化）と抽出器雛形。
- M2 実行: ルール4本を本線化、E2E から JSONアサーション導線を接続。
- M3 実行: CI に Step Summary（検出統計）と SKIP 明文化を追加。
