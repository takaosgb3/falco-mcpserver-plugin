# 目的

MCP Server に対する AI コーディングツール（Codex CLI / Claude Code / 他）のアクセスを可観測化し、セキュアに制御・監査するための Falco プラグイン（以降「MCP プラグイン」）の要件を定義する。

# 前提

- 対象: MCP Server との通信・呼び出し（ツール実行、ファイルアクセス、プロンプト/モデル呼び出し前後のメタデータ）。
- 環境: 自己ホストRunner/ローカル開発環境を想定。Falco 本体はドライバレスで可、E2E は SKIP ポリシーを徹底。
- 方針: SDK-first（`cmd/plugin-sdk/` 系の設計を優先）。CGO は必要最小限。フィールド/ルールは後方互換を重視。
- セキュリティ: ペイロード本体は原則収集しない（メタデータ中心、PII/機密はレッドアクト方針）。

# 結論（要旨）

- フェーズ1では「監査イベントのJSONフィード」を入力にするソース型プラグインで開始（決定論的・テスト容易）。
- フェーズ2で eBPF/システムコール観測やプロキシ連携などに拡張し、ネットワーク/ファイルI/Oを補完。
- 主要フィールド（`mcp.*` 名前空間）と Falco ルールテンプレを定義し、JSON アサーション型 E2E を実装。

# 要件

## 機能要件（観測/変換）
- 入力: MCP 監査イベントの JSON 行（sidecar/proxy/クライアントで生成）。最小スキーマを標準化。
- 変換: Falco フィールドへマッピング（`mcp.*`）。バッチ単位で StringPool を利用しメモリ管理。
- 出力: Falco イベントに `output_fields` として `mcp.*` を付与。
- 異常検出: ルールに基づきアラート生成（例: 未承認エンドポイント/非TLS/大量送信/過剰ツール呼び出し）。

## 観測対象/データモデル（提案スキーマ v1）
必須（MVP）:
- `mcp.session_id`（string）: セッション識別子。
- `mcp.client_process`（string）: 呼び出し元（例: `codex-cli`, `claude-code`）。
- `mcp.server_host`（string）, `mcp.server_port`（uint16）
- `mcp.tls`（bool）: TLS の有無。
- `mcp.auth_scheme`（string）: `none|basic|bearer|mtls|other`。
- `mcp.method`（string）: 実行 API/ツール名（例: `tools.list`, `prompts.get`）。
- `mcp.request_bytes`（uint64）, `mcp.response_bytes`（uint64）
- `mcp.tool_invoke_count`（uint32）, `mcp.file_access_count`（uint32）
- `mcp.timestamp`（uint64, ns）

任意（拡張）:
- `mcp.dataset_id`（string）: データセット/プロジェクト識別。
- `mcp.scope`（string）: 許可スコープ/ポリシー名。
- `mcp.error_code`（string）: エラー/拒否理由。
- `mcp.cert_fingerprint`（string）: TLS サーバ証明書指紋（プライバシー配慮）。

## 検知要件（例）
- 未承認エンドポイント: `mcp.server_host` が許可リスト外。
- 平文通信/疑義 TLS: `mcp.tls=false` または フィンガープリント不一致。
- 過剰権限・危険スコープ: `mcp.scope` が高リスク or 非推奨。
- 大量送信/頻度異常: `mcp.request_bytes` や `mcp.tool_invoke_count` がしきい値超過。
- 機密操作: 特定 `mcp.method`（例: ファイルエクスポート/外部送信）検出。

## ログ/監査
- JSON 監査イベント原本の保存（ローテーション/保持期間/PIIマスキング方針）。
- Falco アラートの JSON 出力と `test-results/` への集約（E2E/CI 用）。
- 監査スキーマのバージョン管理（`schema_version` フィールド）。

## 非機能要件
- パフォーマンス: 低オーバーヘッド（1万イベント/分程度を目標）。
- 安定性: 異常入力（壊れたJSON）時にスキップ・メトリクス化、プラグインは落とさない。
- 互換: フィールド名/型は後方互換。追加は OK、削除/リネームは非推奨。
- メモリ/CGO: StringPool での一括管理、Falco 所有/プラグイン所有の原則順守。

## セキュリティ/プライバシー
- 原則メタデータのみ。コンテンツ（プロンプト/コード本体）は収集しない。
- レッドアクト: `auth`/`path`/`ids` はハッシュ/トークン化オプションを用意。
- 開示: ドキュメント/設定に収集項目と目的を明記。

## 運用要件
- 設定: 許可ドメイン/しきい値/レッドアクトポリシーを `yaml` で外部化。
- 観測: メトリクス（イベント処理数/スキップ数/警告数）をログに記録。
- デバッグ: 入力サンプルの保存/再生（リグレッション用）。

## 互換性/SDK方針
- SDK-first で実装（`cmd/plugin-sdk/` 構造に倣う）。
- ルール/フィールドの整合性を `rules/*` とテストで担保。

# スコープ外（初期）
- フルパケットキャプチャや復号、アプリケーション層コンテンツの恒常的収集。
- すべての MCP 実装の自動検出（まずは標準的 JSON 監査フィード経由）。

# 受入基準（観測可能な条件）
- ユニット: JSON → フィールド変換のテーブル駆動テストが安定通過。
- E2E: 代表シナリオで JSON アサーションが一致（`rule`/`priority`/`output_fields["mcp.*"]`）。
- CI: 自己ホストRunnerで安定起動、必要依存（`jq bc file`）を明示し SKIP 方針を実装。
- ルール: 未承認エンドポイント/非TLS/大量送信/過剰呼び出しのしきい値検知が機能。

# リスク/代替
- 監査フィード未整備 → 代替: 軽量ローカルプロキシで JSON 生成 or クライアントラッパ。
- ルール過検知 → 代替: 検出率しきい値/学習期間/許可リスト緩和を導入。
- プライバシー懸念 → 代替: ハッシュ化/レッドアクト/オプトアウト設定。

# 次アクション
- 監査JSONスキーマの固め: 最小セット（上記 MVP）で `docs/schema/` を定義。
- プラグイン雛形: SDK ベースのソース/抽出プラグインを用意し、テーブル駆動テストを追加。
- ルール最小セット: 4 本（未承認/非TLS/大量送信/過剰呼び出し）+ E2E スクリプト。
- CI 配線: 自己ホストRunnerラベル固定、`jq bc file` 導入、`test-results/` アーティファクト化。

