# セルフホストランナー導入チェックリスト

## 事前準備

### 1. 動作確認の徹底
- [ ] テスト用ワークフローで基本動作を確認
- [ ] 主要なワークフローを個別にテスト実行
- [ ] エラーログの詳細確認

### 2. 段階的な導入
- [ ] まず1-2個のワークフローで試験運用
- [ ] 問題がないことを確認してから全体展開
- [ ] ロールバック手順の準備

### 3. 必須ツールの確認
各ワークフローが必要とするツールを事前に調査：
- [ ] Node.js バージョン要件
- [ ] Go バージョン要件
- [ ] Python要件
- [ ] Docker要件
- [ ] その他のCLIツール

## 導入時のチェックポイント

### 1. 権限設定
- [ ] sudoは最小限の権限のみ付与
- [ ] ファイルシステムの権限確認
- [ ] キャッシュディレクトリの権限

### 2. エラー監視
```bash
# 失敗したワークフローを確認
gh run list --status failure --limit 10

# エラーログの詳細確認
gh run view <RUN_ID> --log-failed | grep -E "Error|error|Failed|failed"

# ランナーのログ確認
kubectl logs -n actions-runner-system <POD_NAME> -c runner
```

### 3. パフォーマンス監視
- [ ] ポッド起動時間の測定
- [ ] ジョブ実行時間の比較（GitHub-hosted vs Self-hosted）
- [ ] リソース使用率の確認

## トラブルシューティング

### よくある問題と解決方法

1. **Permission Denied エラー**
   - キャッシュディレクトリの所有者確認
   - runnerユーザーのUID確認（通常1000）

2. **ツールが見つからない**
   - PATHの設定確認
   - initContainerでのインストール確認

3. **ワークフロー失敗**
   - 詳細ログで具体的なエラーを特定
   - GitHub-hostedで動作することを確認
   - 環境差異の調査

## ロールバック手順

問題が発生した場合：

```bash
# 全てのワークフローをGitHub-hostedに戻す
./k8s/self-hosted-runner/disable-all-self-hosted-runners.sh

# 特定のワークフローのみ戻す
sed -i 's/runs-on: \[self-hosted.*/runs-on: ubuntu-latest/' .github/workflows/<WORKFLOW>.yml
```

## 成功の判定基準

- [ ] 全てのワークフローが正常に実行される
- [ ] エラー率がGitHub-hosted時と同等以下
- [ ] 実行時間が許容範囲内
- [ ] コスト削減効果が確認できる

## 継続的な改善

1. **定期的なレビュー**
   - 月次でエラー率を確認
   - 新しいワークフロー追加時の影響評価

2. **自動化**
   - エラー検知の自動化
   - アラート設定

3. **ドキュメント更新**
   - 新しい問題と解決策を記録
   - ベストプラクティスの更新